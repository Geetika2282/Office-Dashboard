<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #adb9d3, #a8bcd8);
      font-family: 'Inter', sans-serif;
      color: #1f2937;
      min-height: 100vh;
    }
    .sidebar {
      background-color: #1e293b;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      padding-top: 20px;
      color: #ffffff;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
    }
    .sidebar h3 {
      text-align: center;
      margin-bottom: 2rem;
      font-weight: 600;
    }
    .sidebar .nav-link {
      color: #d1d5db;
      padding: 10px 20px;
      border-radius: 5px;
      margin: 5px 10px;
      transition: all 0.3s ease;
    }
    .sidebar .nav-link:hover {
      background-color: #334155;
      color: #ffffff;
    }
    .sidebar .nav-link.active {
      background-color: #334155;
      color: #ffffff;
    }
    .sidebar .nav-link i {
      margin-right: 10px;
    }
    .main-content {
      margin-left: 250px;
      padding: 2rem;
    }
    .container {
      max-width: 1400px;
      padding: 20px;
      margin: 0 auto;
    }
    .dashboard-header {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }
    .dashboard-header h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.8rem;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    .card-header {
      background: #f3f4f6;
      border-bottom: none;
      padding: 16px 24px;
      border-radius: 12px 12px 0 0;
    }
    .card-title {
      font-weight: 700;
      color: #1f2937;
      font-size: 1.25rem;
      margin-bottom: 0;
    }
    .card-body {
      padding: 24px;
    }
    .table {
      margin-top: 20px;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 12px;
      overflow: hidden;
    }
    .table thead th {
      background: #f3f4f6;
      color: #374151;
      font-weight: 600;
      padding: 16px;
      border: none;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .table tbody tr {
      background: #ffffff;
      transition: background 0.2s ease;
    }
    .table tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .table tbody tr:hover {
      background: #e0f2fe;
    }
    .table tbody td {
      padding: 16px;
      vertical-align: middle;
      border: none;
      font-size: 0.95rem;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .action-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border: none;
      font-size: 1rem;
    }
    .action-btn.edit {
      background: #2563eb;
      color: white;
    }
    .action-btn.delete {
      background: #ef4444;
      color: white;
    }
    .action-btn.info {
      background: #0ea5e9;
      color: white;
    }
    .action-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .chart-container {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      height: 350px;
    }
    .modal-content {
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      background: #ffffff;
      border: none;
      animation: fadeIn 0.3s ease;
    }
    .modal-header {
      background: #f9fafb;
      border-bottom: none;
      padding: 20px 24px;
      border-radius: 12px 12px 0 0;
    }
    .modal-title {
      font-weight: 700;
      color: #1f2937;
      font-size: 1.25rem;
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .modal-footer {
      background: #f9fafb;
      border-top: none;
      padding: 16px 24px;
      border-radius: 0 0 12px 12px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .form-group {
      position: relative;
      margin-bottom: 16px;
    }
    .form-group label {
      position: absolute;
      top: 12px;
      left: 12px;
      color: #6b7280;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      pointer-events: none;
      background: #ffffff;
      padding: 0 4px;
    }
    .form-group input:focus + label,
    .form-group input:not(:placeholder-shown) + label,
    .form-group select:focus + label,
    .form-group select:not([value=""]) + label,
    .form-group textarea:focus + label,
    .form-group textarea:not(:placeholder-shown) + label {
      top: -8px;
      left: 8px;
      font-size: 0.75rem;
      color: #2563eb;
      font-weight: 500;
    }
    .form-control, .form-select {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      height: 48px;
    }
    .form-control:focus, .form-select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
      outline: none;
    }
    .form-control.error, .form-select.error {
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239,68,68,0.1);
    }
    .error-message {
      color: #ef4444;
      font-size: 0.8rem;
      margin-top: 4px;
      display: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn-secondary {
      background: #6b7280;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    .btn-secondary:hover {
      background: #4b5563;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn-info {
      background: #0ea5e9;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    .btn-info:hover {
      background: #0284c7;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn-danger {
      background: #ef4444;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    .btn-danger:hover {
      background: #dc2626;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn-edit {
      background: #f59e0b;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    .btn-edit:hover {
      background: #d97706;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .status-indicator {
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .status-success {
      background-color: #e6f4ea;
      color: #1e7e34;
    }
    .status-warning {
      background-color: #fff3e0;
      color: #f57c00;
    }
    .status-danger {
      background-color: #fde7e9;
      color: #dc3545;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .main-content {
        margin-left: 0;
        padding: 1rem;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Admin Panel</h3>
    <ul class="nav flex-column">
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="navigateTo('index.html')"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="navigateTo('staff.html')"><i class="fas fa-users"></i> Staff</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="navigateTo('contract.html')"><i class="fas fa-file-contract"></i> Contract</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="navigateTo('amc.html')"><i class="fas fa-file-contract"></i> AMC</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="navigateTo('vehicle.html')"><i class="fas fa-car-side"></i> Vehicle</a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      <div class="dashboard-header">
        <h2>Vehicle Management System</h2>
      </div>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="vehicles-tab" data-bs-toggle="tab" data-bs-target="#vehicles" type="button" role="tab">Vehicles</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab">Service Records</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="insurance-tab" data-bs-toggle="tab" data-bs-target="#insurance" type="button" role="tab">Insurance Records</button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <!-- Dashboard Section -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
          <div class="row mt-4">
            <div class="col-md-3 mb-4">
              <div class="card">
                <div class="card-body text-center">
                  <h5 class="card-title"><i class="fas fa-car me-2"></i>Total Vehicles</h5>
                  <h2 id="totalVehicles" class="mb-0">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-4">
              <div class="card">
                <div class="card-body text-center">
                  <h5 class="card-title"><i class="fas fa-tools me-2"></i>Active Services</h5>
                  <h2 id="activeServices" class="mb-0">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-4">
              <div class="card">
                <div class="card-body text-center">
                  <h5 class="card-title"><i class="fas fa-shield-alt me-2"></i>Valid Insurances</h5>
                  <h2 id="validInsurances" class="mb-0">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-4">
              <div class="card">
                <div class="card-body text-center">
                  <h5 class="card-title"><i class="fas fa-clock me-2"></i>Due for Service</h5>
                  <h2 id="dueServices" class="mb-0">0</h2>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-4">
              <div class="chart-container">
                <canvas id="serviceChart"></canvas>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="chart-container">
                <canvas id="serviceStatusChart"></canvas>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="chart-container">
                <canvas id="insuranceStatusChart"></canvas>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h4>Recent Activities</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Vehicle</th>
                      <th>Activity</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody id="recentActivities"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Vehicle Management Section -->
        <div class="tab-pane fade" id="vehicles" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h4>Vehicle Registration</h4>
            </div>
            <div class="card-body">
              <form id="vehicleForm" onsubmit="event.preventDefault(); saveVehicle();">
                <div class="form-grid">
                  <div class="form-group">
                    <select class="form-select" id="company" required>
                      <option value="">Select Company</option>
                      <option value="Toyota">Toyota</option>
                      <option value="Honda">Honda</option>
                      <option value="Ford">Ford</option>
                      <option value="BMW">BMW</option>
                    </select>
                    <label for="company">Company *</label>
                  </div>
                  <div class="form-group">
                    <select class="form-select" id="model" required>
                      <option value="">Select Model</option>
                      <option value="Camry">Camry</option>
                      <option value="Civic">Civic</option>
                      <option value="F-150">F-150</option>
                      <option value="X5">X5</option>
                    </select>
                    <label for="model">Model *</label>
                  </div>
                  <div class="form-group">
                    <input type="text" class="form-control" id="registrationNumber" placeholder=" " required>
                    <label for="registrationNumber">Registration Number *</label>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-plus-circle me-2"></i>Register Vehicle</button>
              </form>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h4>Registered Vehicles</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Model</th>
                      <th>Company</th>
                      <th>Registration Number</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vehicleList"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Service Records Section -->
        <div class="tab-pane fade" id="services" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h4>Add Service Record</h4>
            </div>
            <div class="card-body">
              <form id="serviceForm" onsubmit="event.preventDefault(); saveService();">
                <div class="form-grid">
                  <div class="form-group">
                    <select class="form-select" id="vehicleSelect" required>
                      <option value="">Choose vehicle...</option>
                    </select>
                    <label for="vehicleSelect">Select Vehicle *</label>
                  </div>
                  <div class="form-group">
                    <input type="date" class="form-control" id="serviceDate" placeholder=" " required>
                    <label for="serviceDate">Service Date *</label>
                  </div>
                  <div class="form-group">
                    <input type="date" class="form-control" id="nextServiceDate" placeholder=" " required>
                    <label for="nextServiceDate">Next Service Date *</label>
                  </div>
                  <div class="form-group">
                    <textarea class="form-control" id="serviceDescription" placeholder=" " required style="height: 100px;"></textarea>
                    <label for="serviceDescription">Service Description *</label>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-plus-circle me-2"></i>Add Service Record</button>
              </form>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h4>All Service Records</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Vehicle</th>
                      <th>Service Date</th>
                      <th>Next Service</th>
                      <th>Description</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="serviceRecordsList"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Insurance Records Section -->
        <div class="tab-pane fade" id="insurance" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h4>Add Insurance Details</h4>
            </div>
            <div class="card-body">
              <form id="insuranceForm" onsubmit="event.preventDefault(); saveInsurance();">
                <div class="form-grid">
                  <div class="form-group">
                    <select class="form-select" id="insuranceVehicleSelect" required>
                      <option value="">Choose vehicle...</option>
                    </select>
                    <label for="insuranceVehicleSelect">Select Vehicle *</label>
                  </div>
                  <div class="form-group">
                    <input type="text" class="form-control" id="insuranceProvider" placeholder=" " required>
                    <label for="insuranceProvider">Insurance Provider *</label>
                  </div>
                  <div class="form-group">
                    <input type="text" class="form-control" id="policyNumber" placeholder=" " required>
                    <label for="policyNumber">Policy Number *</label>
                  </div>
                  <div class="form-group">
                    <input type="date" class="form-control" id="insuranceStartDate" placeholder=" " required>
                    <label for="insuranceStartDate">Start Date *</label>
                  </div>
                  <div class="form-group">
                    <input type="date" class="form-control" id="insuranceEndDate" placeholder=" " required>
                    <label for="insuranceEndDate">End Date *</label>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-plus-circle me-2"></i>Add Insurance Details</button>
              </form>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h4>All Insurance Records</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Vehicle</th>
                      <th>Provider</th>
                      <th>Policy Number</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="insuranceRecordsList"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vehicle Details Modal -->
  <div class="modal fade" id="vehicleDetailsModal" tabindex="-1" aria-labelledby="vehicleDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="vehicleDetailsModalLabel">Vehicle Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Vehicle Information</h6>
              <button class="btn btn-edit btn-sm" onclick="editVehicleInfo()">
                <i class="fas fa-edit me-1"></i> Edit
              </button>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <p class="mb-1"><strong>Model:</strong> <span id="modalModel"></span></p>
                </div>
                <div class="col-md-4">
                  <p class="mb-1"><strong>Company:</strong> <span id="modalCompany"></span></p>
                </div>
                <div class="col-md-4">
                  <p class="mb-1"><strong>Registration:</strong> <span id="modalRegistration"></span></p>
                </div>
              </div>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Service History</h6>
              <button class="btn btn-edit btn-sm" onclick="addNewService()">
                <i class="fas fa-plus me-1"></i> Add Service
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Service Date</th>
                      <th>Description</th>
                      <th>Next Service</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="modalServiceHistory"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Insurance History</h6>
              <button class="btn btn-edit btn-sm" onclick="addNewInsurance()">
                <i class="fas fa-plus me-1"></i> Add Insurance
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Provider</th>
                      <th>Policy Number</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="modalInsuranceHistory"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i>Close</button>
          <button type="button" class="btn btn-primary" onclick="saveChanges()"><i class="fas fa-save me-1"></i>Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let vehicles = [];
    let services = [];
    let insurances = [];
    let serviceChart, serviceStatusChart, insuranceStatusChart;

    const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];

    function validateForm(formId) {
      const form = document.getElementById(formId);
      const requiredInputs = form.querySelectorAll('input[required], select[required], textarea[required]');
      let isValid = true;

      form.querySelectorAll('.error-message').forEach(el => el.remove());
      requiredInputs.forEach(input => input.classList.remove('error'));

      requiredInputs.forEach(input => {
        if (!input.value.trim()) {
          isValid = false;
          input.classList.add('error');
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.textContent = 'Please fill in this field';
          input.parentNode.appendChild(errorDiv);
          errorDiv.style.display = 'block';
        }
      });

      return isValid;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function saveData() {
      try {
        localStorage.setItem('vehicles', JSON.stringify(vehicles));
        localStorage.setItem('services', JSON.stringify(services));
        localStorage.setItem('insurances', JSON.stringify(insurances));
        updateDashboard();
        updateVehicleList();
        updateServiceRecords();
        updateInsuranceRecords();
        updateVehicleSelects();
      } catch (e) {
        console.error('Error saving to localStorage:', e);
        alert('Failed to save data to localStorage. Check console.');
      }
    }

    function initCharts() {
      const serviceCtx = document.getElementById('serviceChart').getContext('2d');
      serviceChart = new Chart(serviceCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Services Over Time',
            data: [],
            borderColor: '#4e73df',
            tension: 0.1,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { title: { display: true, text: 'Service History', font: { size: 16 } } },
          scales: {
            x: { type: 'time', time: { unit: 'month' }, title: { display: true, text: 'Date' } },
            y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Number of Services' } }
          }
        }
      });

      const serviceStatusCtx = document.getElementById('serviceStatusChart').getContext('2d');
      serviceStatusChart = new Chart(serviceStatusCtx, {
        type: 'pie',
        data: {
          labels: ['Up to Date', 'Due Soon', 'Overdue'],
          datasets: [{ data: [0, 0, 0], backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'] }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { title: { display: true, text: 'Service Status', font: { size: 16 } } }
        }
      });

      const insuranceStatusCtx = document.getElementById('insuranceStatusChart').getContext('2d');
      insuranceStatusChart = new Chart(insuranceStatusCtx, {
        type: 'pie',
        data: {
          labels: ['Valid', 'Expiring Soon', 'Expired'],
          datasets: [{ data: [0, 0, 0], backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'] }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { title: { display: true, text: 'Insurance Status', font: { size: 16 } } }
        }
      });
    }

    function updateDashboard() {
      const today = new Date();
      document.getElementById('totalVehicles').textContent = vehicles.length;
      document.getElementById('activeServices').textContent = services.filter(s => new Date(s.nextServiceDate) >= today).length;
      document.getElementById('validInsurances').textContent = insurances.filter(i => new Date(i.endDate) >= today).length;
      document.getElementById('dueServices').textContent = services.filter(s => {
        const nextService = new Date(s.nextServiceDate);
        return nextService < today || (nextService - today) / (1000 * 60 * 60 * 24) <= 30;
      }).length;

      const months = new Set();
      services.forEach(s => months.add(new Date(s.serviceDate).toISOString().slice(0, 7)));
      const sortedMonths = Array.from(months).sort();
      const serviceCounts = sortedMonths.map(m => services.filter(s => s.serviceDate.startsWith(m)).length);

      serviceChart.data.labels = sortedMonths;
      serviceChart.data.datasets[0].data = serviceCounts;
      serviceChart.update();

      const serviceStatus = [
        services.filter(s => {
          const nextService = new Date(s.nextServiceDate);
          return nextService >= today && (nextService - today) / (1000 * 60 * 60 * 24) > 30;
        }).length,
        services.filter(s => {
          const nextService = new Date(s.nextServiceDate);
          return (nextService - today) / (1000 * 60 * 60 * 24) <= 30 && nextService >= today;
        }).length,
        services.filter(s => new Date(s.nextServiceDate) < today).length
      ];

      serviceStatusChart.data.datasets[0].data = serviceStatus;
      serviceStatusChart.update();

      const insuranceStatus = [
        insurances.filter(i => {
          const endDate = new Date(i.endDate);
          return endDate >= today && (endDate - today) / (1000 * 60 * 60 * 24) > 30;
        }).length,
        insurances.filter(i => {
          const endDate = new Date(i.endDate);
          return (endDate - today) / (1000 * 60 * 60 * 24) <= 30 && endDate >= today;
        }).length,
        insurances.filter(i => new Date(i.endDate) < today).length
      ];

      insuranceStatusChart.data.datasets[0].data = insuranceStatus;
      insuranceStatusChart.update();

      const recentActivities = [
        ...services.map(s => ({
          date: s.serviceDate,
          vehicle: vehicles.find(v => v.id === s.vehicleId)?.registrationNumber || 'Unknown',
          activity: 'Service',
          details: s.serviceDescription
        })),
        ...insurances.map(i => ({
          date: i.startDate,
          vehicle: vehicles.find(v => v.id === i.vehicleId)?.registrationNumber || 'Unknown',
          activity: 'Insurance',
          details: `Provider: ${i.provider}, Policy: ${i.policyNumber}`
        }))
      ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

      document.getElementById('recentActivities').innerHTML = recentActivities.map(a => `
        <tr>
          <td>${formatDate(a.date)}</td>
          <td>${a.vehicle}</td>
          <td>${a.activity}</td>
          <td>${a.details}</td>
        </tr>
      `).join('');
    }

    function saveVehicle() {
      if (!validateForm('vehicleForm')) {
        alert('Please fill all required fields.');
        return;
      }

      const vehicle = {
        id: Date.now().toString(),
        company: document.getElementById('company').value,
        model: document.getElementById('model').value,
        registrationNumber: document.getElementById('registrationNumber').value.trim()
      };

      vehicles.push(vehicle);
      saveData();
      document.getElementById('vehicleForm').reset();
    }

    function updateVehicleList() {
      const tbody = document.getElementById('vehicleList');
      tbody.innerHTML = vehicles.map(v => `
        <tr>
          <td>${v.model}</td>
          <td>${v.company}</td>
          <td>${v.registrationNumber}</td>
          <td class="action-buttons">
            <button class="action-btn info" onclick="viewVehicleDetails('${v.id}')"><i class="fas fa-eye"></i></button>
            <button class="action-btn delete" onclick="deleteVehicle('${v.id}')"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    function saveService() {
      if (!validateForm('serviceForm')) {
        alert('Please fill all required fields.');
        return;
      }

      const service = {
        id: Date.now().toString(),
        vehicleId: document.getElementById('vehicleSelect').value,
        serviceDate: document.getElementById('serviceDate').value,
        nextServiceDate: document.getElementById('nextServiceDate').value,
        serviceDescription: document.getElementById('serviceDescription').value.trim()
      };

      if (new Date(service.serviceDate) > new Date(service.nextServiceDate)) {
        alert('Next Service Date must be after Service Date.');
        return;
      }

      services.push(service);
      saveData();
      document.getElementById('serviceForm').reset();
    }

    function updateServiceRecords() {
      const tbody = document.getElementById('serviceRecordsList');
      tbody.innerHTML = services.map(s => {
        const vehicle = vehicles.find(v => v.id === s.vehicleId);
        const today = new Date();
        const nextService = new Date(s.nextServiceDate);
        let status = 'Up to Date';
        let statusClass = 'status-success';

        if (nextService < today) {
          status = 'Overdue';
          statusClass = 'status-danger';
        } else if ((nextService - today) / (1000 * 60 * 60 * 24) <= 30) {
          status = 'Due Soon';
          statusClass = 'status-warning';
        }

        return `
          <tr>
            <td>${vehicle ? `${vehicle.company} ${vehicle.model}` : 'Unknown'}</td>
            <td>${formatDate(s.serviceDate)}</td>
            <td>${formatDate(s.nextServiceDate)}</td>
            <td>${s.serviceDescription}</td>
            <td><span class="status-indicator ${statusClass}">${status}</span></td>
            <td class="action-buttons">
              <button class="action-btn info" onclick="viewVehicleDetails('${s.vehicleId}')"><i class="fas fa-eye"></i></button>
              <button class="action-btn delete" onclick="deleteService('${s.id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function saveInsurance() {
      if (!validateForm('insuranceForm')) {
        alert('Please fill all required fields.');
        return;
      }

      const insurance = {
        id: Date.now().toString(),
        vehicleId: document.getElementById('insuranceVehicleSelect').value,
        provider: document.getElementById('insuranceProvider').value.trim(),
        policyNumber: document.getElementById('policyNumber').value.trim(),
        startDate: document.getElementById('insuranceStartDate').value,
        endDate: document.getElementById('insuranceEndDate').value
      };

      if (new Date(insurance.startDate) > new Date(insurance.endDate)) {
        alert('End Date must be after Start Date.');
        return;
      }

      insurances.push(insurance);
      saveData();
      document.getElementById('insuranceForm').reset();
    }

    function updateInsuranceRecords() {
      const tbody = document.getElementById('insuranceRecordsList');
      tbody.innerHTML = insurances.map(i => {
        const vehicle = vehicles.find(v => v.id === i.vehicleId);
        const today = new Date();
        const endDate = new Date(i.endDate);
        let status = 'Valid';
        let statusClass = 'status-success';

        if (endDate < today) {
          status = 'Expired';
          statusClass = 'status-danger';
        } else if ((endDate - today) / (1000 * 60 * 60 * 24) <= 30) {
          status = 'Expiring Soon';
          statusClass = 'status-warning';
        }

        return `
          <tr>
            <td>${vehicle ? `${vehicle.company} ${vehicle.model}` : 'Unknown'}</td>
            <td>${i.provider}</td>
            <td>${i.policyNumber}</td>
            <td>${formatDate(i.startDate)}</td>
            <td>${formatDate(i.endDate)}</td>
            <td><span class="status-indicator ${statusClass}">${status}</span></td>
            <td class="action-buttons">
              <button class="action-btn info" onclick="viewVehicleDetails('${i.vehicleId}')"><i class="fas fa-eye"></i></button>
              <button class="action-btn delete" onclick="deleteInsurance('${i.id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateVehicleSelects() {
      const vehicleSelect = document.getElementById('vehicleSelect');
      const insuranceVehicleSelect = document.getElementById('insuranceVehicleSelect');
      const options = '<option value="">Choose vehicle...</option>' +
        vehicles.map(v => `<option value="${v.id}">${v.company} ${v.model} (${v.registrationNumber})</option>`).join('');
      vehicleSelect.innerHTML = options;
      insuranceVehicleSelect.innerHTML = options;
    }

    function viewVehicleDetails(vehicleId) {
      const vehicle = vehicles.find(v => v.id === vehicleId);
      if (!vehicle) return;

      document.getElementById('modalModel').textContent = vehicle.model;
      document.getElementById('modalCompany').textContent = vehicle.company;
      document.getElementById('modalRegistration').textContent = vehicle.registrationNumber;

      const serviceHistory = services.filter(s => s.vehicleId === vehicleId);
      document.getElementById('modalServiceHistory').innerHTML = serviceHistory.map(s => {
        const today = new Date();
        const nextService = new Date(s.nextServiceDate);
        let status = 'Up to Date';
        let statusClass = 'status-success';

        if (nextService < today) {
          status = 'Overdue';
          statusClass = 'status-danger';
        } else if ((nextService - today) / (1000 * 60 * 60 * 24) <= 30) {
          status = 'Due Soon';
          statusClass = 'status-warning';
        }

        return `
          <tr>
            <td>${formatDate(s.serviceDate)}</td>
            <td>${s.serviceDescription}</td>
            <td>${formatDate(s.nextServiceDate)}</td>
            <td><span class="status-indicator ${statusClass}">${status}</span></td>
            <td class="action-buttons">
              <button class="action-btn delete" onclick="deleteService('${s.id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
      }).join('');

      const insuranceHistory = insurances.filter(i => i.vehicleId === vehicleId);
      document.getElementById('modalInsuranceHistory').innerHTML = insuranceHistory.map(i => {
        const today = new Date();
        const endDate = new Date(i.endDate);
        let status = 'Valid';
        let statusClass = 'status-success';

        if (endDate < today) {
          status = 'Expired';
          statusClass = 'status-danger';
        } else if ((endDate - today) / (1000 * 60 * 60 * 24) <= 30) {
          status = 'Expiring Soon';
          statusClass = 'status-warning';
        }

        return `
          <tr>
            <td>${i.provider}</td>
            <td>${i.policyNumber}</td>
            <td>${formatDate(i.startDate)}</td>
            <td>${formatDate(i.endDate)}</td>
            <td><span class="status-indicator ${statusClass}">${status}</span></td>
            <td class="action-buttons">
              <button class="action-btn delete" onclick="deleteInsurance('${i.id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
      }).join('');

      new bootstrap.Modal(document.getElementById('vehicleDetailsModal')).show();
    }

    function editVehicleInfo() {
      const vehicleId = vehicles.find(v => v.registrationNumber === document.getElementById('modalRegistration').textContent)?.id;
      if (!vehicleId) return;

      const vehicle = vehicles.find(v => v.id === vehicleId);
      document.getElementById('company').value = vehicle.company;
      document.getElementById('model').value = vehicle.model;
      document.getElementById('registrationNumber').value = vehicle.registrationNumber;

      vehicles = vehicles.filter(v => v.id !== vehicleId);
      saveData();
      bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
    }

    function addNewService() {
      const vehicleId = vehicles.find(v => v.registrationNumber === document.getElementById('modalRegistration').textContent)?.id;
      if (!vehicleId) return;

      document.getElementById('vehicleSelect').value = vehicleId;
      bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
      document.getElementById('services-tab').click();
    }

    function addNewInsurance() {
      const vehicleId = vehicles.find(v => v.registrationNumber === document.getElementById('modalRegistration').textContent)?.id;
      if (!vehicleId) return;

      document.getElementById('insuranceVehicleSelect').value = vehicleId;
      bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
      document.getElementById('insurance-tab').click();
    }

    function saveChanges() {
      bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
    }

    function deleteVehicle(id) {
      if (confirm('Are you sure you want to delete this vehicle?')) {
        vehicles = vehicles.filter(v => v.id !== id);
        services = services.filter(s => s.vehicleId !== id);
        insurances = insurances.filter(i => i.vehicleId !== id);
        saveData();
      }
    }

    function deleteService(id) {
      if (confirm('Are you sure you want to delete this service record?')) {
        services = services.filter(s => s.id !== id);
        saveData();
        const modal = bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal'));
        if (modal) {
          const vehicleId = vehicles.find(v => v.registrationNumber === document.getElementById('modalRegistration').textContent)?.id;
          viewVehicleDetails(vehicleId);
        }
      }
    }

    function deleteInsurance(id) {
      if (confirm('Are you sure you want to delete this insurance record?')) {
        insurances = insurances.filter(i => i.id !== id);
        saveData();
        const modal = bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal'));
        if (modal) {
          const vehicleId = vehicles.find(v => v.registrationNumber === document.getElementById('modalRegistration').textContent)?.id;
          viewVehicleDetails(vehicleId);
        }
      }
    }

    function navigateTo(page) {
      window.location.href = page;
    }

    document.addEventListener('DOMContentLoaded', function() {
      try {
        vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
        services = JSON.parse(localStorage.getItem('services')) || [];
        insurances = JSON.parse(localStorage.getItem('insurances')) || [];

        initCharts();
        updateDashboard();
        updateVehicleList();
        updateServiceRecords();
        updateInsuranceRecords();
        updateVehicleSelects();

        document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
          tab.addEventListener('click', () => {
            updateDashboard();
            updateVehicleList();
            updateServiceRecords();
            updateInsuranceRecords();
          });
        });
      } catch (e) {
        console.error('Error in DOMContentLoaded:', e);
        alert('Failed to initialize the application. Check console.');
      }
    });
  </script>
</body>
</html>
